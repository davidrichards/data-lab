---

title: Title

keywords: fastai
sidebar: home_sidebar

summary: "summary"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/02.00.develop.utils.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
    
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Develop-Utilities">Develop Utilities<a class="anchor-link" href="#Develop-Utilities">&#182;</a></h1><p>Establish some interfaces for developing work.</p>
<ul>
<li>Pass/Fail and format validation steps.</li>
<li>ValidateCode: Ensures the code should dispatch to an environment</li>
<li>ValidationRecord: ensure the record is ready to be stored</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="listify" class="doc_header"><code>listify</code><a href="https://github.com/davidrichards/data_lab/tree/master/data_lab/develop/utils.py#L15" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>listify</code>(<strong><code>o</code></strong>)</p>
</blockquote>
<p>Create lists from objects</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">assert</span> <span class="n">listify</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="p">[]</span>
<span class="k">assert</span> <span class="n">listify</span><span class="p">([</span><span class="s1">&#39;a&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span>
<span class="k">assert</span> <span class="n">listify</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span>
<span class="k">assert</span> <span class="n">listify</span><span class="p">({</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span> <span class="o">==</span> <span class="p">[{</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}]</span>

<span class="n">passing</span> <span class="o">=</span> <span class="n">_pass_step</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">passing</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;foo&#39;</span>
<span class="k">assert</span> <span class="n">passing</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">PASSING_STATUS</span>
<span class="k">assert</span> <span class="n">_create_step</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">passing</span>

<span class="n">exception</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">trace</span> <span class="o">=</span> <span class="kc">None</span>
<span class="k">try</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;Exception message&quot;</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
    <span class="n">exception</span> <span class="o">=</span> <span class="n">e</span>
<span class="n">failing</span> <span class="o">=</span> <span class="n">_fail_step</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="n">exception</span><span class="o">=</span><span class="n">exception</span><span class="p">,</span> <span class="n">traceback</span><span class="o">=</span><span class="n">trace</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">failing</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;foo&#39;</span>
<span class="k">assert</span> <span class="n">failing</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">FAILING_STATUS</span>
<span class="k">assert</span> <span class="n">failing</span><span class="p">[</span><span class="s1">&#39;traceback&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">trace</span>
<span class="k">assert</span> <span class="n">failing</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Exception message&#39;</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="FormatValidation" class="doc_header"><code>class</code> <code>FormatValidation</code><a href="https://github.com/davidrichards/data_lab/tree/master/data_lab/develop/utils.py#L45" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>FormatValidation</code>(<strong><code>steps</code></strong>, <strong>**<code>kw</code></strong>)</p>
</blockquote>
<p>convert a list of steps into a more-reasonable string explanation
of what took place.</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="format_validation" class="doc_header"><code>format_validation</code><a href="https://github.com/davidrichards/data_lab/tree/master/data_lab/develop/utils.py#L151" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>format_validation</code>(<strong><code>steps</code></strong>, <strong>**<code>kw</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">steps</span> <span class="o">=</span> <span class="p">[</span>
    <span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="s1">&#39;passed&#39;</span><span class="p">),</span>
    <span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="s1">&#39;passed&#39;</span><span class="p">),</span>
    <span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="s1">&#39;failed&#39;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s1">&#39;Explain problems with c&#39;</span><span class="p">),</span>
    <span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="s1">&#39;passed&#39;</span><span class="p">),</span>
    <span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;e&#39;</span><span class="p">),</span>
    <span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="s1">&#39;failed&#39;</span><span class="p">),</span>
    <span class="nb">dict</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="s1">&#39;failed&#39;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Something went wrong in a malformed step&quot;</span><span class="p">),</span>
<span class="p">]</span>

<span class="n">subject</span> <span class="o">=</span> <span class="n">FormatValidation</span><span class="p">(</span><span class="n">steps</span><span class="p">)</span>
<span class="k">assert</span> <span class="ow">not</span> <span class="n">subject</span><span class="o">.</span><span class="n">valid</span>
<span class="k">assert</span> <span class="n">subject</span><span class="o">.</span><span class="n">message</span> <span class="o">==</span> <span class="n">subject</span><span class="o">.</span><span class="n">failing_message</span>
<span class="k">assert</span> <span class="n">subject</span><span class="p">()</span> <span class="o">==</span> <span class="n">subject</span><span class="o">.</span><span class="n">message</span>
<span class="k">assert</span> <span class="s2">&quot;Validation failed&quot;</span> <span class="ow">in</span> <span class="n">subject</span><span class="p">()</span>
<span class="k">assert</span> <span class="s2">&quot;Success with: a&quot;</span> <span class="ow">in</span> <span class="n">subject</span><span class="p">()</span>
<span class="k">assert</span> <span class="s2">&quot;Failing step&quot;</span> <span class="ow">in</span> <span class="n">subject</span><span class="p">()</span>
<span class="k">assert</span> <span class="s2">&quot;Possible problem&quot;</span> <span class="ow">in</span> <span class="n">subject</span><span class="p">()</span>

<span class="k">assert</span> <span class="s2">&quot;Validation was successful&quot;</span> <span class="ow">in</span> <span class="n">FormatValidation</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">steps</span><span class="p">,</span> <span class="n">valid</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">assert</span> <span class="s2">&quot;No successful steps were reported&quot;</span> <span class="ow">in</span> <span class="n">FormatValidation</span><span class="o">.</span><span class="n">call</span><span class="p">([])</span>
<span class="k">assert</span> <span class="n">FormatValidation</span><span class="p">([])</span><span class="o">.</span><span class="n">valid</span>
<span class="k">assert</span> <span class="s2">&quot;No successful steps were reported&quot;</span> <span class="ow">in</span> <span class="n">FormatValidation</span><span class="o">.</span><span class="n">call</span><span class="p">([{</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="n">FAILING_STATUS</span><span class="p">}],</span> <span class="n">valid</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">assert</span> <span class="s2">&quot;Validation was successful&quot;</span> <span class="ow">in</span> <span class="n">format_validation</span><span class="p">([])</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="find_package" class="doc_header"><code>find_package</code><a href="https://github.com/davidrichards/data_lab/tree/master/data_lab/develop/utils.py#L154" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>find_package</code>(<strong><code>package</code></strong>, <strong><code>parent</code></strong>=<em><code>None</code></em>)</p>
</blockquote>
<p>Find a package through imports.</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="find_code" class="doc_header"><code>find_code</code><a href="https://github.com/davidrichards/data_lab/tree/master/data_lab/develop/utils.py#L176" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>find_code</code>(<strong><code>name</code></strong>, <strong><code>package</code></strong>=<em><code>None</code></em>)</p>
</blockquote>
<p>Use text descriptions to find executable code.</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">assert</span> <span class="n">find_package</span><span class="p">(</span><span class="s2">&quot;not a package&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span>
<span class="k">assert</span> <span class="n">find_package</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="s2">&quot;parent&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">None</span>
<span class="k">assert</span> <span class="n">find_package</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span>
<span class="k">assert</span> <span class="n">find_package</span><span class="p">(</span><span class="s1">&#39;math&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">math</span>
<span class="k">assert</span> <span class="n">find_package</span><span class="p">(</span><span class="s1">&#39;matplotlib.pyplot&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">plt</span>
<span class="k">assert</span> <span class="n">find_package</span><span class="p">(</span><span class="s1">&#39;matplotlib.pyplot.not_a_thing&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span>
<span class="k">assert</span> <span class="n">find_package</span><span class="p">(</span><span class="n">plt</span><span class="p">)</span> <span class="o">==</span> <span class="n">plt</span>

<span class="n">foo</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="mi">42</span>
<span class="k">assert</span> <span class="n">find_code</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">)()</span> <span class="o">==</span> <span class="mi">42</span>
<span class="k">assert</span> <span class="n">find_code</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="n">package</span><span class="o">=</span><span class="kc">None</span><span class="p">)()</span> <span class="o">==</span> <span class="mi">42</span>
<span class="k">assert</span> <span class="n">find_code</span><span class="p">(</span><span class="s1">&#39;acos&#39;</span><span class="p">,</span> <span class="n">package</span><span class="o">=</span><span class="s1">&#39;math&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">math</span><span class="o">.</span><span class="n">acos</span>
<span class="k">assert</span> <span class="n">find_code</span><span class="p">(</span><span class="s1">&#39;acorr&#39;</span><span class="p">,</span> <span class="n">package</span><span class="o">=</span><span class="s1">&#39;matplotlib.pyplot&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">plt</span><span class="o">.</span><span class="n">acorr</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>I want to have a robust way to get code so I can store references to it in tables and files. For example, if a treatment depends on some scikit-learn code, I want to be able to reference it and store the hyperparameters.</p>
<p>This ties to the idea that work can be dispatched locally or remotely, that systems can be developed that are appropriate for training or serving models.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="ValidateCode" class="doc_header"><code>class</code> <code>ValidateCode</code><a href="https://github.com/davidrichards/data_lab/tree/master/data_lab/develop/utils.py#L187" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>ValidateCode</code>(<strong>**<code>kw</code></strong>)</p>
</blockquote>
<p>Validate code works. This is currently defaulted for a Treatment,
but as I develop other tools, I'll come up with a more generic way to
to do this.</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="validate_code" class="doc_header"><code>validate_code</code><a href="https://github.com/davidrichards/data_lab/tree/master/data_lab/develop/utils.py#L270" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>validate_code</code>(<strong>**<code>kw</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">_SpecialTreatment</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Treatment used for testing.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;model...that needs to duck type&#39;</span>
    
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span>

<span class="n">base</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;_SpecialTreatment&#39;</span>
<span class="p">)</span>

<span class="n">subject</span> <span class="o">=</span> <span class="n">ValidateCode</span><span class="p">(</span><span class="o">**</span><span class="n">base</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">subject</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">base</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
<span class="k">assert</span> <span class="n">subject</span><span class="o">.</span><span class="n">fn</span> <span class="o">==</span> <span class="n">_SpecialTreatment</span>
<span class="k">assert</span> <span class="n">subject</span><span class="o">.</span><span class="n">steps</span> <span class="o">==</span> <span class="n">ValidateCode</span><span class="o">.</span><span class="n">DEFAULT_STEPS</span>

<span class="n">subject</span> <span class="o">=</span> <span class="n">ValidateCode</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;acos&#39;</span><span class="p">,</span> <span class="n">package</span><span class="o">=</span><span class="s1">&#39;math&#39;</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">subject</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;acos&#39;</span>
<span class="k">assert</span> <span class="n">subject</span><span class="o">.</span><span class="n">package</span> <span class="o">==</span> <span class="s1">&#39;math&#39;</span>
<span class="k">assert</span> <span class="n">subject</span><span class="o">.</span><span class="n">fn</span> <span class="o">==</span> <span class="n">math</span><span class="o">.</span><span class="n">acos</span>

<span class="n">model_keywords</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tools&#39;</span><span class="p">:</span> <span class="s1">&#39;for the model&#39;</span><span class="p">}</span>
<span class="n">subject</span> <span class="o">=</span> <span class="n">ValidateCode</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;_SpecialTreatment&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">model_keywords</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">subject</span><span class="o">.</span><span class="n">unused_keywords</span> <span class="o">==</span> <span class="n">model_keywords</span>
<span class="n">expected</span> <span class="o">=</span> <span class="n">_SpecialTreatment</span><span class="p">()(</span><span class="o">**</span><span class="n">model_keywords</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">subject</span><span class="o">.</span><span class="n">model</span> <span class="o">==</span> <span class="n">expected</span>
<span class="n">passed</span><span class="p">,</span> <span class="n">steps</span> <span class="o">=</span> <span class="n">subject</span><span class="p">()</span>
<span class="k">assert</span> <span class="n">passed</span>

<span class="n">passed</span><span class="p">,</span> <span class="n">steps</span> <span class="o">=</span> <span class="n">validate_code</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;acos&#39;</span><span class="p">,</span> <span class="n">package</span><span class="o">=</span><span class="s1">&#39;math&#39;</span><span class="p">)</span>
<span class="k">assert</span> <span class="ow">not</span> <span class="n">passed</span>
<span class="n">explanation</span> <span class="o">=</span> <span class="n">format_validation</span><span class="p">(</span><span class="n">steps</span><span class="p">)</span>
<span class="k">assert</span> <span class="s2">&quot;Failing step: configure model&quot;</span> <span class="ow">in</span> <span class="n">explanation</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>At this point we can validate some code. As mentioneed above, it's still specific to a treatment, with the exception of duck typing the treatment--will it work with other tools? That's coming.</p>
<p>I don't like the way I'm building the model, sharing keywords, sharing details at high levels. Given some use of treatments, I've got to redesign some interfaces.</p>
<p>Also, it's probably OK that I create classes for the heavy lifting, but I've been hesitant to bring load_once and load_once_property into this library. Keeping it simple is pedantic.</p>
<p>Some things will move out to a utilities module:</p>
<ul>
<li>FormatValidation</li>
<li>_pass_step and _fail_step</li>
<li>Some of the dictionary utilities in FormatValidation</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="ValidateRecord" class="doc_header"><code>class</code> <code>ValidateRecord</code><a href="https://github.com/davidrichards/data_lab/tree/master/data_lab/develop/utils.py#L274" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>ValidateRecord</code>(<strong>**<code>kw</code></strong>)</p>
</blockquote>
<p>Given the state of a record, the data we record around the code,
is it valid? ValidateCode deals with whether the validation should work
with our environment. This code deals with whether we're setting the right
attributes in the database.</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="validate_records" class="doc_header"><code>validate_records</code><a href="https://github.com/davidrichards/data_lab/tree/master/data_lab/develop/utils.py#L402" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>validate_records</code>(<strong>**<code>kw</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">subject</span> <span class="o">=</span> <span class="n">ValidateRecord</span><span class="p">()</span>
<span class="k">assert</span> <span class="n">subject</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="nb">list</span><span class="p">(</span><span class="n">ValidateRecord</span><span class="o">.</span><span class="n">ALLOWED_MAP</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">assert</span> <span class="ow">not</span> <span class="n">subject</span><span class="o">.</span><span class="n">valid</span>

<span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
<span class="n">basic_values</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span>
    <span class="n">version</span> <span class="o">=</span> <span class="s1">&#39;1.2.3&#39;</span><span class="p">,</span>
    <span class="n">contributors</span> <span class="o">=</span> <span class="s1">&#39;someone_else&#39;</span><span class="p">,</span>
    <span class="n">now</span> <span class="o">=</span> <span class="n">now</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">subject</span> <span class="o">=</span> <span class="n">ValidateRecord</span><span class="p">(</span><span class="o">**</span><span class="n">basic_values</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">subject</span><span class="o">.</span><span class="n">_get_field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;foo&#39;</span>
<span class="k">assert</span> <span class="n">subject</span><span class="o">.</span><span class="n">version</span><span class="p">[</span><span class="s1">&#39;major&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;1&#39;</span>
<span class="k">assert</span> <span class="n">subject</span><span class="o">.</span><span class="n">version</span><span class="p">[</span><span class="s1">&#39;minor&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;2&#39;</span>
<span class="k">assert</span> <span class="n">subject</span><span class="o">.</span><span class="n">version</span><span class="p">[</span><span class="s1">&#39;patch&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;3&#39;</span>
<span class="k">assert</span> <span class="n">subject</span><span class="o">.</span><span class="n">contributors</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;someone_else&#39;</span><span class="p">,</span> <span class="n">subject</span><span class="o">.</span><span class="n">user</span><span class="p">]</span>
<span class="k">assert</span> <span class="n">subject</span><span class="o">.</span><span class="n">created_at</span> <span class="o">==</span> <span class="n">now</span>
<span class="k">assert</span> <span class="n">subject</span><span class="o">.</span><span class="n">updated_at</span> <span class="o">==</span> <span class="n">now</span>
<span class="k">assert</span> <span class="n">subject</span><span class="o">.</span><span class="n">valid</span>
<span class="n">valid</span><span class="p">,</span> <span class="n">attributes</span> <span class="o">=</span> <span class="n">subject</span><span class="p">()</span>
<span class="k">assert</span> <span class="n">valid</span>
<span class="k">assert</span> <span class="n">attributes</span> <span class="o">==</span> <span class="n">subject</span><span class="o">.</span><span class="n">attributes</span>

<span class="k">with</span> <span class="n">check_raises</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s1">&#39;Invalid state raises...is this what I want?&#39;</span><span class="p">):</span>
    <span class="n">subject</span> <span class="o">=</span> <span class="n">ValidateRecord</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s1">&#39;not a state&#39;</span><span class="p">)</span>
    <span class="n">subject</span><span class="o">.</span><span class="n">valid</span>
    
<span class="n">subject</span> <span class="o">=</span> <span class="n">ValidateRecord</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s1">&#39;validated&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">basic_values</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">subject</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s1">&#39;validated&#39;</span>
<span class="k">assert</span> <span class="ow">not</span> <span class="n">subject</span><span class="o">.</span><span class="n">valid</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="store" class="doc_header"><code>store</code><a href="https://github.com/davidrichards/data_lab/tree/master/data_lab/develop/utils.py#L406" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>store</code>(<strong><code>object_store</code></strong>=<em><code>'data_lab.object_store.noop'</code></em>, <strong>**<code>kw</code></strong>)</p>
</blockquote>
<p>Store the record, if valid, in the provided object store. Defaults to a noop data store.</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="start" class="doc_header"><code>start</code><a href="https://github.com/davidrichards/data_lab/tree/master/data_lab/develop/utils.py#L413" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>start</code>(<strong>**<code>kw</code></strong>)</p>
</blockquote>
<p>Start a new record, ensuring the state is correct.</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="increment_version" class="doc_header"><code>increment_version</code><a href="https://github.com/davidrichards/data_lab/tree/master/data_lab/develop/utils.py#L418" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>increment_version</code>(<strong><code>version</code></strong>, <strong><code>level</code></strong>=<em><code>'patch'</code></em>, <strong>**<code>kw</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="string_version" class="doc_header"><code>string_version</code><a href="https://github.com/davidrichards/data_lab/tree/master/data_lab/develop/utils.py#L439" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>string_version</code>(<strong><code>version</code></strong>, <strong>**<code>kw</code></strong>)</p>
</blockquote>
<p>Convert a dictionary version to a string format</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="revise" class="doc_header"><code>revise</code><a href="https://github.com/davidrichards/data_lab/tree/master/data_lab/develop/utils.py#L445" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>revise</code>(<strong><code>name</code></strong>, <strong><code>item</code></strong>=<em><code>None</code></em>, <strong><code>object_store</code></strong>=<em><code>'data_lab.object_store.noop'</code></em>, <strong>**<code>kw</code></strong>)</p>
</blockquote>
<p>Revise a record, using the name to find the old record, if it exists.</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">assert</span> <span class="n">string_version</span><span class="p">(</span><span class="n">increment_version</span><span class="p">(</span><span class="s1">&#39;0.1.1&#39;</span><span class="p">))</span> <span class="o">==</span> <span class="s1">&#39;0.1.2&#39;</span>
<span class="k">assert</span> <span class="n">string_version</span><span class="p">(</span><span class="n">increment_version</span><span class="p">(</span><span class="s1">&#39;0.1.1&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;minor&#39;</span><span class="p">))</span> <span class="o">==</span> <span class="s1">&#39;0.2.0&#39;</span>
<span class="k">assert</span> <span class="n">string_version</span><span class="p">(</span><span class="n">increment_version</span><span class="p">(</span><span class="s1">&#39;0.1.1&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">))</span> <span class="o">==</span> <span class="s1">&#39;1.0.0&#39;</span>

<span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">store</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;foo&#39;</span><span class="p">),</span> <span class="nb">dict</span><span class="p">)</span>
<span class="k">assert</span> <span class="ow">not</span> <span class="n">store</span><span class="p">()</span> <span class="c1"># Not valid, no name</span>

<span class="n">version</span> <span class="o">=</span> <span class="n">start</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="s1">&#39;0.1.0&#39;</span><span class="p">)[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span>
<span class="k">assert</span> <span class="n">string_version</span><span class="p">(</span><span class="n">version</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;0.1.0&#39;</span>

<span class="n">previous</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">-</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
<span class="n">existing</span> <span class="o">=</span> <span class="n">start</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="n">contributors</span><span class="o">=</span><span class="s1">&#39;someone_else&#39;</span><span class="p">,</span> <span class="n">now</span><span class="o">=</span><span class="n">previous</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">string_version</span><span class="p">(</span><span class="n">existing</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="s1">&#39;0.0.1&#39;</span>
<span class="n">revised</span> <span class="o">=</span> <span class="n">revise</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="n">item</span><span class="o">=</span><span class="n">existing</span><span class="p">,</span> <span class="n">now</span><span class="o">=</span><span class="n">now</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">revised</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;revised&#39;</span>
<span class="k">assert</span> <span class="n">revised</span><span class="p">[</span><span class="s1">&#39;updated_at&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">now</span>
<span class="k">assert</span> <span class="s1">&#39;someone_else&#39;</span> <span class="ow">in</span> <span class="n">revised</span><span class="p">[</span><span class="s1">&#39;contributors&#39;</span><span class="p">]</span>
<span class="k">assert</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getuser</span><span class="p">()</span> <span class="ow">in</span> <span class="n">revised</span><span class="p">[</span><span class="s1">&#39;contributors&#39;</span><span class="p">]</span>
<span class="k">assert</span> <span class="n">string_version</span><span class="p">(</span><span class="n">revised</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="s1">&#39;0.0.2&#39;</span>
</pre></div>

    </div>
</div>
</div>

</div>
</div>
 

