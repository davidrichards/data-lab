---

title: Title

keywords: fastai
sidebar: home_sidebar

summary: "summary"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/03_loop.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
    
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="TODO:">TODO:<a class="anchor-link" href="#TODO:">&#182;</a></h1><ul>
<li>train/test/split</li>
<li>evaluation slips/review</li>
<li>Progress Bar</li>
<li>Picle and joblib</li>
<li>Minio</li>
<li>Storage + ObjectStoree</li>
<li>Model metadata</li>
<li>Treatment type + storage</li>
<li>Evaluation type + storage</li>
<li>Subject type + storage</li>
<li>Full processing loop with storage, versions, search</li>
<li>changelog/report centrally</li>
<li>fix documentation/flow (possibly upgrade nbdev)</li>
</ul>
<h2 id="Later">Later<a class="anchor-link" href="#Later">&#182;</a></h2><ul>
<li>NLP</li>
<li>automl</li>
<li>unsupervised</li>
<li>semi-supervised</li>
<li>FastAI v2</li>
<li>manual pipelines</li>
<li>PySpark pipeline</li>
<li>Great Expectations</li>
<li>Kibana</li>
<li>SQS + Terraform</li>
<li>cache</li>
<li>Flask</li>
<li>Monitoring</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Loop">Loop<a class="anchor-link" href="#Loop">&#182;</a></h1><p>Training should be done on a loop: subjects and treatments all getting consistent model evaluation with results stored centrally.  Basically, create reproducible results quickly, automate the easy stuff.</p>
<p>Here I gather a few utilities, practices, interfaces, and demonstrations to make this easier for everyone.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%</span><span class="k">matplotlib</span> inline
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">requests</span>

<span class="kn">import</span> <span class="nn">datetime</span> <span class="k">as</span> <span class="nn">dt</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">hashlib</span>

<span class="kn">from</span> <span class="nn">sklearn</span> <span class="kn">import</span> <span class="n">model_selection</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">from</span> <span class="nn">sklearn.tree</span> <span class="kn">import</span> <span class="n">DecisionTreeClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.neighbors</span> <span class="kn">import</span> <span class="n">KNeighborsClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.discriminant_analysis</span> <span class="kn">import</span> <span class="n">LinearDiscriminantAnalysis</span>
<span class="kn">from</span> <span class="nn">sklearn.naive_bayes</span> <span class="kn">import</span> <span class="n">GaussianNB</span>
<span class="kn">from</span> <span class="nn">sklearn.svm</span> <span class="kn">import</span> <span class="n">SVC</span>

<span class="kn">from</span> <span class="nn">lab.util.test_functions</span> <span class="kn">import</span> <span class="o">*</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="artifact_storage" class="doc_header"><code>artifact_storage</code><a href="https://github.com/davidrichards/lab/tree/master/lab/train/loop.py#L7" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>artifact_storage</code>(<strong>*<code>a</code></strong>, <strong>**<code>kw</code></strong>)</p>
</blockquote>
<p>Infer how the user intends to store
artifacts: models, versions, treatments,
and evaluation results.</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="generic_runner" class="doc_header"><code>generic_runner</code><a href="https://github.com/davidrichards/lab/tree/master/lab/train/loop.py#L15" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>generic_runner</code>(<strong><code>subject</code></strong>, <strong><code>treatment</code></strong>, <strong>*<code>a</code></strong>, <strong>**<code>kw</code></strong>)</p>
</blockquote>
<p>Naive concept. I have something smarter
running somewhere, but I'm not sure where it is.</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="runner" class="doc_header"><code>runner</code><a href="https://github.com/davidrichards/lab/tree/master/lab/train/loop.py#L23" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>runner</code>(<strong>*<code>a</code></strong>, <strong>**<code>kw</code></strong>)</p>
</blockquote>
<p>Infer the runner and its artifact storage.</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="train_loop" class="doc_header"><code>train_loop</code><a href="https://github.com/davidrichards/lab/tree/master/lab/train/loop.py#L27" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>train_loop</code>(<strong><code>subjects</code></strong>, <strong><code>treatments</code></strong>, <strong>*<code>a</code></strong>, <strong>**<code>kw</code></strong>)</p>
</blockquote>
<p>The main training loop.</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># This is not normal...expecting to use models, fit, predict,</span>
<span class="c1"># hyper parameters, etc.</span>

<span class="k">def</span> <span class="nf">t</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">subject</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">subject</span> <span class="o">+</span> <span class="n">n</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{name}</span><span class="s2">: </span><span class="si">{result}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>

<span class="k">def</span> <span class="nf">t1</span><span class="p">(</span><span class="n">subject</span><span class="p">):</span> <span class="k">return</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;t1&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">subject</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">t2</span><span class="p">(</span><span class="n">subject</span><span class="p">):</span> <span class="k">return</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;t2&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">subject</span><span class="p">)</span>

<span class="n">subjects</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="mi">10</span>
<span class="nb">print</span><span class="p">(</span><span class="n">subjects</span><span class="p">)</span>

<span class="n">train_loop</span><span class="p">(</span><span class="n">subjects</span><span class="p">,</span> <span class="p">[</span><span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>[12.02844088  8.9797755  10.1115382 ]
t1: 13.03
t2: 14.03
t1: 9.98
t2: 10.98
t1: 11.11
t2: 12.11
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>So far, garbage.</p>
<p>There's a possibility that I'm going this way, but I did that in reverse. So, I started fixing some things by training some models. And, that's giving me something more useful.</p>
<p>The following is still wrong, but better.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The <a href="https://docs.python.org/3/library/hashlib.html">MD5 stuff</a> is kind of cool, but I always forget a step and have to look it up:</p>
<ul>
<li>convert input to a string</li>
<li>build a hashing object (use hashlib's tools)</li>
<li>update the hashing object with a utf-8-encoded string</li>
<li>create a hex digest</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">to_md5</span><span class="p">(</span><span class="o">*</span><span class="n">s</span><span class="p">):</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">()</span>
    <span class="n">m</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">ObjectStore</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Pass through extract from a set of ordered</span>
<span class="sd">    stores, or get the data directly.&quot;&quot;&quot;</span>
    
    <span class="c1"># TODO: replace with configured values</span>
    <span class="n">LOCAL_CACHE</span> <span class="o">=</span> <span class="s1">&#39;/tmp&#39;</span>
    
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">)(</span><span class="n">url</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kw</span> <span class="o">=</span> <span class="n">kw</span>
        
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">local_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a path for the directory where data is cached.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_local_cache&#39;</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_local_cache</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_local_cache</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;local_cache&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">LOCAL_CACHE</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_local_cache</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">certs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_certs&#39;</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_certs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_certs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;certs&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_certs</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">allow_raise</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_allow_raise&#39;</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_allow_raise</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_allow_raise</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;allow_raise&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_allow_raise</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">re_fetch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;When true, overwrite the local cache from the remote source.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_re_fetch&#39;</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_re_fetch</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_re_fetch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;re_fetch&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_re_fetch</span>
    
    <span class="k">def</span> <span class="nf">local_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert a filename to an MD5 hash and join it</span>
<span class="sd">        to the local cache.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_cache</span> <span class="o">/</span> <span class="n">to_md5</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">content_from_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Use requests to fetch content from a url&quot;&quot;&quot;</span>
        <span class="n">kw</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">certs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">kw</span><span class="p">[</span><span class="s1">&#39;certs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">certs</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span><span class="o">.</span><span class="n">content</span>
            <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_raise</span><span class="p">:</span> <span class="k">raise</span>
            <span class="k">return</span> <span class="kc">False</span>
        
    <span class="k">def</span> <span class="nf">get_local_content</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read content from the local cache&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">re_fetch</span><span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>
            <span class="n">local</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_file</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">local</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span> <span class="k">return</span> <span class="kc">False</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_raise</span><span class="p">:</span> <span class="k">raise</span>
            <span class="k">return</span> <span class="kc">False</span>
        
    <span class="k">def</span> <span class="nf">get_remote_content</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read content from a remote path&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">content_from_url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="n">local</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_file</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="s1">&#39;decode&#39;</span><span class="p">):</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">content</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">content</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_raise</span><span class="p">:</span> <span class="k">raise</span>
            <span class="k">return</span> <span class="kc">False</span>
    
    <span class="k">def</span> <span class="nf">local_or_remote</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a local version of the data</span>
<span class="sd">        or get it, save it, and return it.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_local_content</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="ow">or</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_remote_content</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_or_remote</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    
<span class="k">class</span> <span class="nc">ValuesFromUrl</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Convert CSV content into a 2-d NumPy array.&quot;&quot;&quot;</span>
    
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">)(</span><span class="n">url</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kw</span> <span class="o">=</span> <span class="n">kw</span>

    <span class="k">def</span> <span class="nf">content</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Use ObjectStore to get CSV data.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">ObjectStore</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">kw</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Use Pandas to convert CSV to NumPy.&quot;&quot;&quot;</span>
        <span class="n">content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="n">content</span><span class="p">))</span><span class="o">.</span><span class="n">values</span>
    
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">subject</span> <span class="o">=</span> <span class="n">ObjectStore</span><span class="p">()</span>
<span class="k">assert</span> <span class="n">ObjectStore</span><span class="p">(</span><span class="n">local_cache</span><span class="o">=</span><span class="s1">&#39;local&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">local_cache</span> <span class="o">==</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;local&#39;</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">subject</span><span class="o">.</span><span class="n">local_cache</span> <span class="o">==</span> <span class="n">Path</span><span class="p">(</span><span class="n">ObjectStore</span><span class="o">.</span><span class="n">LOCAL_CACHE</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">ObjectStore</span><span class="p">(</span><span class="n">certs</span><span class="o">=</span><span class="s1">&#39;certs&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">certs</span> <span class="o">==</span> <span class="s1">&#39;certs&#39;</span>
<span class="n">root</span> <span class="o">=</span> <span class="n">subject</span><span class="o">.</span><span class="n">local_cache</span>
<span class="n">expected</span> <span class="o">=</span> <span class="n">root</span><span class="o">/</span><span class="n">to_md5</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">subject</span><span class="o">.</span><span class="n">local_file</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">expected</span>

<span class="n">invalid_url</span> <span class="o">=</span> <span class="s1">&#39;http://invalid.example.com/some_file&#39;</span>
<span class="k">assert</span> <span class="ow">not</span> <span class="n">subject</span><span class="o">.</span><span class="n">content_from_url</span><span class="p">(</span><span class="n">invalid_url</span><span class="p">)</span>
<span class="k">with</span> <span class="n">check_raises</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s2">&quot;Can permit raises with `allow_raise=True`.&quot;</span><span class="p">):</span>
    <span class="n">ObjectStore</span><span class="p">(</span><span class="n">allow_raise</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">content_from_url</span><span class="p">(</span><span class="n">invalid_url</span><span class="p">)</span>
<span class="k">assert</span> <span class="ow">not</span> <span class="n">ObjectStore</span><span class="p">(</span><span class="n">re_fetch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">allow_raise</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">get_local_content</span><span class="p">(</span><span class="n">invalid_url</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The ObjectStore can get data remotely, with certs. If it does that, it will store it locally. If the content is already stored locally, it returns that instead.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">content_from_url</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get the content from the ObjectStore&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">ObjectStore</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">dataframe_from_url</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a Pandas DataFrame from content.&quot;&quot;&quot;</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">ObjectStore</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="n">content</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">values_from_url</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get the NumPy array from url&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">ValuesFromUrl</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">white_list</span><span class="p">(</span><span class="n">keywords</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">require_keys</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Filter a dictionary by a set of keys&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">require_keys</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span><span class="n">keywords</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">}</span>
    <span class="k">return</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span><span class="n">keywords</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">k_fold</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Use scikit-learn&#39;s KFold with some control</span>
<span class="sd">    on reasonable defaults.&quot;&quot;&quot;</span>
    <span class="n">defaults</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;n_splits&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">}</span>
    <span class="n">kw</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">defaults</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">model_selection</span><span class="o">.</span><span class="n">KFold</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">process_model</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">storage</span><span class="o">=</span><span class="p">{},</span> <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;accuracy&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Process a model using K-Fold cross validation.&quot;&quot;&quot;</span>
    <span class="n">kfold</span> <span class="o">=</span> <span class="n">k_fold</span><span class="p">()</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">model_selection</span><span class="o">.</span><span class="n">cross_val_score</span><span class="p">(</span>
        <span class="n">model</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span>
        <span class="n">cv</span><span class="o">=</span><span class="n">kfold</span><span class="p">,</span> <span class="n">scoring</span><span class="o">=</span><span class="n">scoring</span>
    <span class="p">)</span>
    <span class="n">store</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">storage</span><span class="o">=</span><span class="n">storage</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">store</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">storage</span><span class="o">=</span><span class="p">{}):</span>
    <span class="sd">&quot;&quot;&quot;Simple storage of treatment results.&quot;&quot;&quot;</span>
    <span class="n">storage</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>

<span class="k">def</span> <span class="nf">plot_results</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Algorithm Comparison&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a box plot for each treatment in a results dictionary.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">plot</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">plot</span> <span class="o">=</span> <span class="n">plt</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">plot</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
    <span class="n">plot</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">cheap_loop</span><span class="p">(</span><span class="n">treatments</span><span class="p">,</span> <span class="n">subjects</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create models without hyperparameter fine tuning</span>
<span class="sd">    to determine which algorithms show promise on a particular</span>
<span class="sd">    dataset&quot;&quot;&quot;</span>
    <span class="n">storage</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span> <span class="ow">in</span> <span class="n">treatments</span><span class="p">:</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="ow">in</span> <span class="n">subjects</span><span class="p">:</span>
            <span class="n">process_model</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">model</span><span class="p">(),</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">storage</span><span class="o">=</span><span class="n">storage</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">display</span><span class="p">:</span> <span class="n">plot_results</span><span class="p">(</span><span class="n">storage</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">storage</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://raw.githubusercontent.com/jbrownlee/Datasets/master/pima-indians-diabetes.data.csv&quot;</span>
<span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;preg&#39;</span><span class="p">,</span> <span class="s1">&#39;plas&#39;</span><span class="p">,</span> <span class="s1">&#39;pres&#39;</span><span class="p">,</span> <span class="s1">&#39;skin&#39;</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="s1">&#39;mass&#39;</span><span class="p">,</span> <span class="s1">&#39;pedi&#39;</span><span class="p">,</span> <span class="s1">&#39;age&#39;</span><span class="p">,</span> <span class="s1">&#39;class&#39;</span><span class="p">]</span>
<span class="n">array</span> <span class="o">=</span> <span class="n">values_from_url</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="n">names</span><span class="p">)</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">array</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">array</span><span class="p">[:,</span><span class="mi">8</span><span class="p">]</span>

<span class="n">treatments</span> <span class="o">=</span> <span class="p">[</span>
<span class="c1">#     (&#39;LR&#39;, LogisticRegression,</span>
    <span class="p">(</span><span class="s1">&#39;LDA&#39;</span><span class="p">,</span> <span class="n">LinearDiscriminantAnalysis</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;KNN&#39;</span><span class="p">,</span> <span class="n">KNeighborsClassifier</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;CART&#39;</span><span class="p">,</span> <span class="n">DecisionTreeClassifier</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;NB&#39;</span><span class="p">,</span> <span class="n">GaussianNB</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;SVM&#39;</span><span class="p">,</span> <span class="n">SVC</span><span class="p">),</span>
<span class="p">]</span>

<span class="n">subjects</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span>
<span class="p">]</span>

<span class="n">cheap_loop</span><span class="p">(</span><span class="n">treatments</span><span class="p">,</span> <span class="n">subjects</span><span class="p">);</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_png output_subarea ">
<img src="data:image/png;base64,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
"
>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The cheap_loop is a quick-and-dirty approach to treating data (no hyperparameters are explored).</p>
<p>LogisticRegression is throwing warnings, so I'm just skipping it for now.</p>
<p>Could use some slips, combine some other work I've done, approach different scoring, quite a few other things.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">cv</span> <span class="o">=</span> <span class="n">k_fold</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Understinding the interface with a bunch of training.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">model_selection</span><span class="o">.</span><span class="n">cross_validate</span><span class="p">(</span><span class="n">LinearDiscriminantAnalysis</span><span class="p">(),</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="n">cv</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>{&#39;fit_time&#39;: array([0.00302601, 0.00173497, 0.00167012, 0.00139809, 0.00173903,
        0.001436  , 0.00150013, 0.00164413, 0.00149512, 0.00141072]),
 &#39;score_time&#39;: array([0.00044608, 0.00035596, 0.00035524, 0.00032306, 0.00037813,
        0.00033116, 0.00036192, 0.00035405, 0.00032997, 0.00031328]),
 &#39;test_score&#39;: array([0.7012987 , 0.80519481, 0.75324675, 0.68831169, 0.79220779,
        0.76623377, 0.83116883, 0.84210526, 0.76315789, 0.80263158])}</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">cv</span><span class="o">.</span><span class="vm">__dict__</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>{&#39;n_splits&#39;: 10, &#39;shuffle&#39;: False, &#39;random_state&#39;: None}</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">model_selection</span><span class="o">.</span><span class="n">cross_validate</span><span class="p">(</span><span class="n">LinearDiscriminantAnalysis</span><span class="p">(),</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>{&#39;fit_time&#39;: array([0.00251389, 0.00251484, 0.00193787, 0.00174499, 0.00153184]),
 &#39;score_time&#39;: array([0.00047803, 0.00047898, 0.00037909, 0.00038695, 0.00037003]),
 &#39;test_score&#39;: array([0.77272727, 0.73376623, 0.74509804, 0.81045752, 0.77124183])}</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The n_jobs determines how many CPUs to use.</p>
<p>Having a wrapper around such a powerful wrapper is weird, but not everything is scikit-learn. So, using a PyTorch example, wrapping with these tools, could be a good justification or a wake up moment that this really is a bad idea (the way I'm abstracting it).</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">model_selection</span><span class="o">.</span><span class="n">cross_validate</span><span class="p">(</span><span class="n">LinearDiscriminantAnalysis</span><span class="p">(),</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>[Parallel(n_jobs=1)]: Using backend SequentialBackend with 1 concurrent workers.
[Parallel(n_jobs=1)]: Done   5 out of   5 | elapsed:    0.0s finished
</pre>
</div>
</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>{&#39;fit_time&#39;: array([0.00260496, 0.00175476, 0.00209212, 0.00187087, 0.00159526]),
 &#39;score_time&#39;: array([0.00068378, 0.00043297, 0.00042701, 0.00041699, 0.00039482]),
 &#39;test_score&#39;: array([0.77272727, 0.73376623, 0.74509804, 0.81045752, 0.77124183])}</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">model_selection</span><span class="o">.</span><span class="n">cross_validate</span><span class="p">(</span><span class="n">LinearDiscriminantAnalysis</span><span class="p">(),</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>[CV]  ................................................................
[CV] ................................................. , total=   0.0s
[CV]  ................................................................
[CV] ................................................. , total=   0.0s
[CV]  ................................................................
[CV] ................................................. , total=   0.0s
[CV]  ................................................................
[CV] ................................................. , total=   0.0s
[CV]  ................................................................
[CV] ................................................. , total=   0.0s
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>[Parallel(n_jobs=1)]: Using backend SequentialBackend with 1 concurrent workers.
[Parallel(n_jobs=1)]: Done   1 out of   1 | elapsed:    0.0s remaining:    0.0s
[Parallel(n_jobs=1)]: Done   5 out of   5 | elapsed:    0.0s finished
</pre>
</div>
</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>{&#39;fit_time&#39;: array([0.0026257 , 0.00195503, 0.00225401, 0.00254393, 0.00213003]),
 &#39;score_time&#39;: array([0.00045514, 0.00042295, 0.00057507, 0.00043297, 0.00042009]),
 &#39;test_score&#39;: array([0.77272727, 0.73376623, 0.74509804, 0.81045752, 0.77124183])}</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">model_selection</span><span class="o">.</span><span class="n">cross_validate</span><span class="p">(</span><span class="n">LinearDiscriminantAnalysis</span><span class="p">(),</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>[CV]  ................................................................
[CV] .................................... , score=0.773, total=   0.0s
[CV]  ................................................................
[CV] .................................... , score=0.734, total=   0.0s
[CV]  ................................................................
[CV] .................................... , score=0.745, total=   0.0s
[CV]  ................................................................
[CV] .................................... , score=0.810, total=   0.0s
[CV]  ................................................................
[CV] .................................... , score=0.771, total=   0.0s
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>[Parallel(n_jobs=1)]: Using backend SequentialBackend with 1 concurrent workers.
[Parallel(n_jobs=1)]: Done   1 out of   1 | elapsed:    0.0s remaining:    0.0s
[Parallel(n_jobs=1)]: Done   2 out of   2 | elapsed:    0.0s remaining:    0.0s
[Parallel(n_jobs=1)]: Done   5 out of   5 | elapsed:    0.0s finished
</pre>
</div>
</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>{&#39;fit_time&#39;: array([0.002141  , 0.00188589, 0.00202012, 0.00236964, 0.00209069]),
 &#39;score_time&#39;: array([0.00051093, 0.00039077, 0.00040102, 0.00040126, 0.00040007]),
 &#39;test_score&#39;: array([0.77272727, 0.73376623, 0.74509804, 0.81045752, 0.77124183])}</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>OK, so verbosity is kind of cool. The docs didn't show me what I could more easily just check here. I can get information about the concurrency, or see each job visually while it works.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">model_selection</span><span class="o">.</span><span class="n">cross_validate</span><span class="p">(</span><span class="n">LinearDiscriminantAnalysis</span><span class="p">(),</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">return_train_score</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>{&#39;fit_time&#39;: array([0.00171804, 0.00250912, 0.00168514, 0.0018239 , 0.0016768 ]),
 &#39;score_time&#39;: array([0.00048113, 0.00055289, 0.00044179, 0.00044107, 0.00042415]),
 &#39;test_score&#39;: array([0.77272727, 0.73376623, 0.74509804, 0.81045752, 0.77124183]),
 &#39;train_score&#39;: array([0.78303426, 0.76998369, 0.77850163, 0.76872964, 0.78501629])}</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">model_selection</span><span class="o">.</span><span class="n">cross_validate</span><span class="p">(</span><span class="n">LinearDiscriminantAnalysis</span><span class="p">(),</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">return_estimator</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>{&#39;fit_time&#39;: array([0.0019691 , 0.00163603, 0.00172901, 0.00164294, 0.00198793]),
 &#39;score_time&#39;: array([0.00043082, 0.00040984, 0.00040197, 0.00039506, 0.00041318]),
 &#39;estimator&#39;: (LinearDiscriminantAnalysis(n_components=None, priors=None, shrinkage=None,
                             solver=&#39;svd&#39;, store_covariance=False, tol=0.0001),
  LinearDiscriminantAnalysis(n_components=None, priors=None, shrinkage=None,
                             solver=&#39;svd&#39;, store_covariance=False, tol=0.0001),
  LinearDiscriminantAnalysis(n_components=None, priors=None, shrinkage=None,
                             solver=&#39;svd&#39;, store_covariance=False, tol=0.0001),
  LinearDiscriminantAnalysis(n_components=None, priors=None, shrinkage=None,
                             solver=&#39;svd&#39;, store_covariance=False, tol=0.0001),
  LinearDiscriminantAnalysis(n_components=None, priors=None, shrinkage=None,
                             solver=&#39;svd&#39;, store_covariance=False, tol=0.0001)),
 &#39;test_score&#39;: array([0.77272727, 0.73376623, 0.74509804, 0.81045752, 0.77124183])}</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>So, at this point I've got some comfort around what works, or at least how this works. I'm a little loose on scoring (I should explore and grok that much better).</p>
<p>Working in this way is worth 10 articles. There is no replacement for experimentation.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">model_selection</span><span class="o">.</span><span class="n">cross_val_score</span><span class="p">(</span><span class="n">LinearDiscriminantAnalysis</span><span class="p">(),</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>array([0.77272727, 0.73376623, 0.74509804, 0.81045752, 0.77124183])</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>What's nice about cross_val_score is it has mostly the same interface as cross_validate, but it only returns the scoring. If I'm not going to keep the fit time and score time, then I can just ignore that.</p>
<p>What I'm starting to think is I should normally keep the fit time. I also want a predict time and a develop time. It takes 3 days to build a model, say, and 10 minutes to train it and the resulting model can run in 100 milliseconds. Knowing that, I can spend 5 days building something that trains in 2 hours but returns either better results, or faster results, or some reason to have it.</p>
<p>These are the values needed in the lab and in production. There are always a lot of metrics flying around, and developing confidence with what they mean and what to do needs to be translated into an experiential flow instead of a reflective stall.</p>
<p>--</p>
<p>At this point I'm thinking about abstraction again. What should I use? Do I want kfold?</p>
<p>It's not as important as I made it.</p>
<p>Do I want to go to a pandas dataframe?</p>
<p>Maybe for now, but once I get a better sense of extract X, y, then maybe not so much.</p>
<p>Why didn't you use tools for splitting the data?</p>
<p>I think they had the cross validation, that those needed to be static. It makes assumptions about the data too, that they're independently and randomly distributed in the dataset. If I didn't have that, I should have split the data with tools.</p>
<p>OK, so this is useful:</p>
<ul>
<li>abstraction is off, can work better</li>
<li>grok is off (I'm shooting from the hip)</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Notes:</p>
<ul>
<li><a href="https://docs.python.org/3/reference/datamodel.html?emulating-container-types#emulating-container-types">emulating containers</a></li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_matches" class="doc_header"><code>get_matches</code><a href="https://github.com/davidrichards/lab/tree/master/lab/train/loop.py#L37" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_matches</code>(<strong><code>r</code></strong>, <strong><code>s</code></strong>)</p>
</blockquote>
<p>Return all matches, or an empty list.</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_nth_match" class="doc_header"><code>get_nth_match</code><a href="https://github.com/davidrichards/lab/tree/master/lab/train/loop.py#L43" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_nth_match</code>(<strong><code>r</code></strong>, <strong><code>s</code></strong>, <strong><code>n</code></strong>)</p>
</blockquote>
<p>Search the string for a regular expression.
If there is a match, return the nth value(s).</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_first_match" class="doc_header"><code>get_first_match</code><a href="https://github.com/davidrichards/lab/tree/master/lab/train/loop.py#L53" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_first_match</code>(<strong><code>r</code></strong>, <strong><code>s</code></strong>)</p>
</blockquote>
<p>Shorthand for get_nth_match.</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">r</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;(.+), (.+), and (.+)&#39;</span>
<span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;a, b, and c&quot;</span>
<span class="k">assert</span> <span class="n">get_nth_match</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span> <span class="o">==</span> <span class="nb">list</span><span class="p">(</span><span class="s1">&#39;ab&#39;</span><span class="p">)</span>

<span class="n">r</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;test_(.+)&#39;</span>
<span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;test_accuracy&#39;</span>
<span class="k">assert</span> <span class="n">get_matches</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span>
<span class="k">assert</span> <span class="n">get_first_match</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;accuracy&#39;</span>

<span class="n">r</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;foo_bar&#39;</span>
<span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;No match&#39;</span>
<span class="k">assert</span> <span class="n">get_first_match</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Able to extract keys out of strings, using a regular expression without exposing the internal re quirks.</p>
<p>If I know what I'm doing, I can use a slice.</p>
<p>This comes from a <a href="https://stackoverflow.com/questions/15340582/python-extract-pattern-matches">StackOverflow question</a>.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">IncrementVersion</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Increment a version string.</span>
<span class="sd">    There are packages for this (bumpversion) and</span>
<span class="sd">    package-management tools, but I thought this</span>
<span class="sd">    would be easier than it was.&quot;&quot;&quot;</span>
    
    <span class="n">DEFAULT_VERSION</span> <span class="o">=</span> <span class="s1">&#39;0.0.0&#39;</span>
    <span class="n">LEVELS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="s1">&#39;minor&#39;</span><span class="p">,</span> <span class="s1">&#39;patch&#39;</span><span class="p">]</span>
    <span class="n">DEFAULT_LEVEL</span> <span class="o">=</span> <span class="s1">&#39;patch&#39;</span>
    <span class="n">ZEROS</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">()(</span><span class="n">version</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">split_version</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">version</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">version</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ZEROS</span>
        
    <span class="k">def</span> <span class="nf">get_version_parts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">version</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a 3-piece version&quot;&quot;&quot;</span>
        <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_version</span><span class="p">(</span><span class="n">version</span><span class="p">)[:</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ZEROS</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">values</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">increment_version</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;patch&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Increment the major, minor, or patch.</span>
<span class="sd">        Pass in the value, if an explicit value is needed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">level</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">LEVELS</span><span class="p">:</span> <span class="n">level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DEFAULT_LEVEL</span>
        <span class="n">level_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LEVELS</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">level</span><span class="p">)</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_version_parts</span><span class="p">(</span><span class="n">version</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">parts</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">level_index</span><span class="p">:</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="n">level_index</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">value</span> <span class="o">=</span> <span class="n">e</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">)</span>
                
        <span class="k">return</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">increment_version</span><span class="p">(</span><span class="n">version</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">assert</span> <span class="n">IncrementVersion</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s1">&#39;0.0.1&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;0.0.2&#39;</span>
<span class="k">assert</span> <span class="n">IncrementVersion</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;0.0.1&#39;</span>
<span class="k">assert</span> <span class="n">IncrementVersion</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;1.0.0&#39;</span>
<span class="k">assert</span> <span class="n">IncrementVersion</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s1">&#39;0.1.1&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;minor&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;0.2.0&#39;</span>
<span class="k">assert</span> <span class="n">IncrementVersion</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s1">&#39;1.1.1.1&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;flurb&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;1.1.2&#39;</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This seems to work, with a missing version, different values, nonsense inputs, too-long inputs...it wasn't worth it writing my own, but there you have it.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">Storage</span><span class="p">:</span>
    <span class="n">TEST_RE</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;test_(.+)&#39;</span>
    <span class="n">DEFAULT_VERSION</span> <span class="o">=</span> <span class="s1">&#39;0.0.1&#39;</span>
    <span class="n">DEFAULT</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">version</span><span class="o">=</span><span class="n">DEFAULT_VERSION</span><span class="p">,</span>
        <span class="n">fit_params</span><span class="o">=</span><span class="p">{},</span>
        <span class="n">tests</span><span class="o">=</span><span class="p">{},</span>
        <span class="n">fit_time</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">trained_at</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">)</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kw</span> <span class="o">=</span> <span class="n">kw</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">records</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">archive</span> <span class="o">=</span> <span class="p">[]</span>
        
    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">records</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__length_hint</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__len__</span><span class="p">()</span>
    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">records</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_retire</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;If it exists, retire the old version of a record.</span>
<span class="sd">        Return the version of that record.</span>
<span class="sd">        Otherwise return False.</span>
<span class="sd">        Either way, this value can be incremented to get a new</span>
<span class="sd">        version.&quot;&quot;&quot;</span>
        <span class="n">old</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">records</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">old</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>
        <span class="n">old</span><span class="p">[</span><span class="s1">&#39;model_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">archive</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">old</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">old</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;version&#39;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_get_version</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Retire an old record if it exists and increment the version.&quot;&quot;&quot;</span>
        <span class="n">old_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_retire</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">IncrementVersion</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">old_version</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_get_default</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Merge the best ideas for a default record.&quot;&quot;&quot;</span>
        <span class="n">version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_version</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">record</span> <span class="o">=</span> <span class="p">{</span>
            <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">DEFAULT</span><span class="p">,</span>
            <span class="o">**</span><span class="p">{</span><span class="s1">&#39;version&#39;</span><span class="p">:</span> <span class="n">version</span><span class="p">},</span>
            <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">records</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">{})</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">record</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;trained_at&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">record</span><span class="p">[</span><span class="s1">&#39;trained_at&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">record</span>
        
    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_default</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">get_first_match</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_RE</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">record</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">record</span><span class="p">[</span><span class="s1">&#39;tests&#39;</span><span class="p">][</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">records</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">record</span>
        <span class="k">return</span> <span class="n">record</span>
    
    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">records</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">get_demo_data</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a simple/reusable dataset (y, X).</span>
<span class="sd">    TODO: Use a more-generic splitting technique.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">url</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://raw.githubusercontent.com/jbrownlee/Datasets/master/pima-indians-diabetes.data.csv&quot;</span>
    <span class="n">array</span> <span class="o">=</span> <span class="n">ValuesFromUrl</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">array</span><span class="p">[:,</span><span class="mi">8</span><span class="p">],</span> <span class="n">array</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">y</span><span class="p">,</span> <span class="n">X</span> <span class="o">=</span> <span class="n">get_demo_data</span><span class="p">()</span>
<span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="mi">767</span><span class="p">,)</span>
<span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="mi">767</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">subject</span> <span class="o">=</span> <span class="n">Storage</span><span class="p">()</span>
<span class="k">assert</span> <span class="nb">str</span><span class="p">(</span><span class="n">subject</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">({})</span> <span class="c1"># Basic repr</span>
<span class="k">assert</span> <span class="n">subject</span><span class="p">[</span><span class="s1">&#39;not_found&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="c1"># Safe/simpler to get</span>

<span class="n">r1</span> <span class="o">=</span> <span class="n">model_selection</span><span class="o">.</span><span class="n">cross_validate</span><span class="p">(</span><span class="n">LinearDiscriminantAnalysis</span><span class="p">(),</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="n">subject</span><span class="p">[</span><span class="s1">&#39;LDA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r1</span>
<span class="k">assert</span> <span class="n">subject</span><span class="p">[</span><span class="s1">&#39;LDA&#39;</span><span class="p">][</span><span class="s1">&#39;version&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;0.0.1&#39;</span>
<span class="k">assert</span> <span class="n">subject</span><span class="p">[</span><span class="s1">&#39;LDA&#39;</span><span class="p">][</span><span class="s1">&#39;fit_params&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">Storage</span><span class="o">.</span><span class="n">DEFAULT</span><span class="p">[</span><span class="s1">&#39;fit_params&#39;</span><span class="p">]</span>
<span class="n">lda_tests</span> <span class="o">=</span> <span class="n">subject</span><span class="p">[</span><span class="s1">&#39;LDA&#39;</span><span class="p">][</span><span class="s1">&#39;tests&#39;</span><span class="p">]</span>
<span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">lda_tests</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">r1</span><span class="p">[</span><span class="s1">&#39;test_score&#39;</span><span class="p">])</span>
<span class="k">assert</span> <span class="s1">&#39;trained_at&#39;</span> <span class="ow">in</span> <span class="n">subject</span><span class="p">[</span><span class="s1">&#39;LDA&#39;</span><span class="p">]</span>
<span class="k">assert</span> <span class="s1">&#39;score_time&#39;</span> <span class="ow">in</span> <span class="n">subject</span><span class="p">[</span><span class="s1">&#39;LDA&#39;</span><span class="p">]</span>

<span class="n">r2_now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
<span class="n">r2</span> <span class="o">=</span> <span class="n">model_selection</span><span class="o">.</span><span class="n">cross_validate</span><span class="p">(</span>
    <span class="n">LinearDiscriminantAnalysis</span><span class="p">(),</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span>
    <span class="n">scoring</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">,</span> <span class="s1">&#39;f1&#39;</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">r2</span><span class="p">[</span><span class="s1">&#39;trained_at&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r2_now</span>
<span class="n">subject</span><span class="p">[</span><span class="s1">&#39;LDA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r2</span>
<span class="n">archived</span> <span class="o">=</span> <span class="n">subject</span><span class="o">.</span><span class="n">archive</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="k">assert</span> <span class="n">archived</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;0.0.1&#39;</span>
<span class="k">assert</span> <span class="n">archived</span><span class="p">[</span><span class="s1">&#39;model_name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;LDA&#39;</span>
<span class="k">assert</span> <span class="n">subject</span><span class="p">[</span><span class="s1">&#39;LDA&#39;</span><span class="p">][</span><span class="s1">&#39;version&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;0.0.2&#39;</span>
<span class="k">assert</span> <span class="n">subject</span><span class="p">[</span><span class="s1">&#39;LDA&#39;</span><span class="p">][</span><span class="s1">&#39;trained_at&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">r2_now</span>
<span class="k">assert</span> <span class="s1">&#39;accuracy&#39;</span> <span class="ow">in</span> <span class="n">subject</span><span class="p">[</span><span class="s1">&#39;LDA&#39;</span><span class="p">][</span><span class="s1">&#39;tests&#39;</span><span class="p">]</span>
<span class="k">assert</span> <span class="s1">&#39;f1&#39;</span> <span class="ow">in</span> <span class="n">subject</span><span class="p">[</span><span class="s1">&#39;LDA&#39;</span><span class="p">][</span><span class="s1">&#39;tests&#39;</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Storage is kind of cool at this point. It allows me to treat storage like it's a dictionary, meaning it's a cheap replacement for an in-memory tool. It adds some versioning, timestamping, archiving, and basically invents an easy-to-mock interface for storage. Later, this will wrap something like MinIO. That might not be 100% appropriate, but I want to ease into something I can understand/mock/extend.</p>
<p>From here, I'd like to add some new wraps around the basic processing. Replace what's above with similar below. Specifically:</p>
<p><strong>Treatments</strong> I want to create some defaults around treatments that just work. This is for baseline models, classification, regression, unsupervised, semi-supervised, NLP, deep learning--all of it. Make it easy to find and pick what's normal in a situation.</p>
<p><strong>Slips</strong> I want to put more slips in my notebooks. I want to store/find/reuse these as documentation. I'm making a notebook a multi-step production, which slows it down. Let me just drop a <code>#slip</code> comment at the top of a markdown cell and make that searchable. I'll include full references in those cells.</p>
<p><strong>Evaluation</strong> I want to develop transparency around evaluation. What's common? What can I reuse? Again, I'm dealing with all the kinds of models and analysis here. Not everything applies to everything, but I want to have a quick way of seeing that good work is consistently done, or the most-obvious thing is to do the best practice first. The idea is that I want to train models with my best ideas, learn better ones, and start evaluating in better ways later, coming back to earlier models if I choose to.</p>
<p><strong>Processing</strong> Make the process just work: subjects and treatments, evaluations and storage. Create a learning loop.</p>
<p><strong>Storage</strong> Storage isn't quite done yet. Yes, there's the permanent version of this, an object storage, likely in MinIO. Also, there's storing models. Let me move those easily into production once they're trained, evaluated, tuned, and approved-of here. This suggests an interface change, that I was probably naive with what I did above on Storage.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">

<pre><code># {'fit_time': array([0.00210023, 0.00220704, 0.00217891, 0.00219107, 0.00271726]),
#  'score_time': array([0.00784898, 0.00204897, 0.00181198, 0.00148892, 0.00190783]),
#  'test_accuracy': array([0.77272727, 0.74025974, 0.74025974, 0.81045752, 0.77777778]),
#  'test_balanced_accuracy': array([0.72703704, 0.71055556, 0.68074074, 0.77075472, 0.72358491])}



def k_fold(**kw):
    """Use scikit-learn's KFold with some control
    on reasonable defaults."""
    defaults = {'n_splits': 10}
    kw = {**defaults, **kw}
    return model_selection.KFold(**kw)

def process_model(name, model, X, Y, storage={}, scoring='accuracy', **kw):
    """Process a model using K-Fold cross validation."""
    kfold = k_fold()
    result = model_selection.cross_val_score(
        model, X, Y,
        cv=kfold, scoring=scoring
    )
    return store(name, result, storage=storage)

def store(name, result, storage={}):
    """Simple storage of treatment results."""
    storage[name] = result
    return storage

def plot_results(results, plot=None, title='Algorithm Comparison', **kw):
    """Create a box plot for each treatment in a results dictionary."""
    if plot is None: plot = plt

    fig = plot.figure()
    fig.suptitle(title)
    ax = fig.add_subplot(111)
    plt.boxplot(list(results.values()))
    ax.set_xticklabels(list(results.keys()))
    plot.show()

def cheap_loop(treatments, subjects, display=True, **kw):
    """Create models without hyperparameter fine tuning
    to determine which algorithms show promise on a particular
    dataset"""
    storage = {}
    for (name, model) in treatments:
        for (x, y) in subjects:
            process_model(name, model(), x, y, storage=storage)
    if display: plot_results(storage, **kw)
    return storage</code></pre>

</div>
</div>
</div>
</div>
 

